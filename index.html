<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe dApp</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Ethers.js CDN for blockchain interaction -->
    <script src="https://cdn.ethers.io/scripts/ethers-v5.7.2.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            stroke-width: 2;
            stroke: currentColor;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center p-4 min-h-screen antialiased">

    <div id="app" class="container mx-auto max-w-2xl">
        <div id="card" class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div id="card-header" class="text-center p-6 bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                <h1 class="text-4xl font-extrabold tracking-tight">Tic-Tac-Toe dApp</h1>
                <p class="text-blue-100 mt-2 text-md">A multiplayer game on the Somnia Testnet</p>
            </div>
            <div id="card-content" class="p-6 space-y-6">
                <!-- Connect Wallet Section -->
                <div id="connect-wallet-section" class="flex flex-col items-center gap-4 text-center">
                    <h3 class="text-xl font-semibold">Connect your wallet to play</h3>
                    <p class="text-gray-500">
                        You need to use a wallet like MetaMask and connect it to the Somnia Testnet.
                    </p>
                    <button id="connect-wallet-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                        Connect Wallet
                    </button>
                </div>

                <!-- Game UI Section (Hidden by default) -->
                <div id="game-ui-section" class="hidden flex flex-col items-center gap-6">
                    <div class="flex items-center gap-4 flex-wrap justify-center text-sm font-medium" id="player-info">
                        <!-- Player badges will be dynamically inserted here -->
                    </div>
                    <div class="flex flex-col items-center gap-2 text-center w-full">
                        <h4 class="text-2xl font-bold tracking-tight">
                            Game State: <span class="text-purple-600" id="game-state-text"></span>
                        </h4>
                        <p class="text-lg text-gray-700" id="current-player-text">
                            <!-- Current player turn will be dynamically inserted here -->
                        </p>
                    </div>

                    <div id="board-grid" class="grid grid-cols-3 gap-4 w-full aspect-square max-w-sm">
                        <!-- Board squares will be dynamically inserted here -->
                    </div>

                    <div id="game-actions" class="flex gap-4 mt-4">
                        <!-- Game action buttons will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Message Box -->
                <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                        <h3 id="message-box-title" class="text-lg font-bold mb-2"></h3>
                        <p id="message-box-text" class="text-gray-600 mb-4"></p>
                        <button id="message-box-close" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">
                            OK
                        </button>
                    </div>
                </div>
            </div>

            <div id="card-footer" class="flex justify-center p-4 bg-gray-50 text-gray-400 text-xs">
                Powered by Somnia Network & deployed via Vercel
            </div>
        </div>
    </div>

    <script>
        // IMPORTANT: The contract address has been updated to your provided value.
        const contractAddress = "0xf9E24384B638aF3D3425918D35d146BFA7ebd4bd";

        // IMPORTANT: The contract ABI has been updated to your provided value.
        const contractABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "winner",
                        "type": "address"
                    }
                ],
                "name": "GameEnded",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player1",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player2",
                        "type": "address"
                    }
                ],
                "name": "GameStarted",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "joinGame",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "row",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "col",
                        "type": "uint256"
                    }
                ],
                "name": "makeMove",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "row",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "col",
                        "type": "uint256"
                    }
                ],
                "name": "MoveMade",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "resetGame",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "board",
                "outputs": [
                    {
                        "internalType": "enum TicTacToe.SquareState",
                        "name": "",
                        "type": "uint8"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "currentPlayer",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "gameState",
                "outputs": [
                    {
                        "internalType": "enum TicTacToe.GameState",
                        "name": "",
                        "type": "uint8"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "player1",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "player2",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        const gameStateLabels = {
          0: "Waiting for Player 2",
          1: "In Progress",
          2: "Player 1 Won",
          3: "Player 2 Won",
          4: "Draw",
        };

        const app = document.getElementById('app');
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const connectWalletSection = document.getElementById('connect-wallet-section');
        const gameUiSection = document.getElementById('game-ui-section');
        const playerInfoDiv = document.getElementById('player-info');
        const gameStateText = document.getElementById('game-state-text');
        const currentPlayerText = document.getElementById('current-player-text');
        const boardGrid = document.getElementById('board-grid');
        const gameActionsDiv = document.getElementById('game-actions');
        const messageBox = document.getElementById('message-box');
        const messageBoxTitle = document.getElementById('message-box-title');
        const messageBoxText = document.getElementById('message-box-text');
        const messageBoxCloseBtn = document.getElementById('message-box-close');

        let provider;
        let signer;
        let contract;
        let userAddress;
        let player1Address;
        let player2Address;
        let currentPlayerAddress;

        // --- Utility Functions ---

        /**
         * @dev Shows a custom message box instead of using alert().
         * @param title The title of the message box.
         * @param message The message to display.
         */
        function showMessage(title, message) {
            messageBoxTitle.textContent = title;
            messageBoxText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        messageBoxCloseBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        function truncateAddress(address) {
            if (!address) return '';
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        // --- Blockchain Interaction Functions ---

        /**
         * @dev Connects the user's wallet and initializes the contract instance.
         */
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showMessage("Wallet Not Found", "Please install a browser wallet like MetaMask and refresh the page.");
                return;
            }

            try {
                // Request accounts and create a provider
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum, 'any');

                const network = await provider.getNetwork();
                // Ensure the user is on the Somnia Testnet
                if (network.chainId !== 50312) {
                    showMessage("Wrong Network", "Please connect to the Somnia Testnet (Chain ID: 50312).");
                    return;
                }

                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Initialize the contract instance
                contract = new ethers.Contract(contractAddress, contractABI, signer);

                // Switch UI to game mode
                connectWalletSection.classList.add('hidden');
                gameUiSection.classList.remove('hidden');

                // Start listening for events and update UI
                startEventListeners();
                updateUI();
            } catch (error) {
                console.error("Error connecting wallet:", error);
                showMessage("Connection Failed", "Could not connect to your wallet. Please check your browser's wallet extension.");
            }
        }

        /**
         * @dev Fetches all game state from the contract and updates the UI.
         */
        async function updateUI() {
            if (!contract) return;
            try {
                const [p1, p2, currentP, state] = await Promise.all([
                    contract.player1(),
                    contract.player2(),
                    contract.currentPlayer(),
                    contract.gameState()
                ]);

                player1Address = p1;
                player2Address = p2;
                currentPlayerAddress = currentP;
                const gameState = state.toNumber();

                // Update player info badges
                renderPlayerInfo(player1Address, player2Address, userAddress);

                // Update game state text
                gameStateText.textContent = gameStateLabels[gameState];

                // Update current player turn text
                if (gameState === 1) {
                    const isMyTurn = currentPlayerAddress.toLowerCase() === userAddress.toLowerCase();
                    currentPlayerText.innerHTML = `It's currently <span class="bg-yellow-500 text-yellow-900 font-bold rounded-full px-2 py-1 text-sm">${isMyTurn ? "Your" : truncateAddress(currentPlayerAddress)}</span> turn.`;
                } else {
                    currentPlayerText.textContent = '';
                }

                // Update the board
                renderBoard(gameState);

                // Update game action buttons
                renderGameActions(gameState);
                
            } catch (error) {
                console.error("Error updating UI:", error);
                showMessage("Error", "Could not fetch game state from the blockchain.");
            }
        }

        /**
         * @dev Renders the player address badges.
         * @param p1 The address of player 1.
         * @param p2 The address of player 2.
         * @param myAddress The current user's address.
         */
        function renderPlayerInfo(p1, p2, myAddress) {
            playerInfoDiv.innerHTML = `
                <div class="bg-blue-500 hover:bg-blue-600 text-white cursor-pointer px-3 py-1 rounded-full text-xs transition-colors duration-200">
                    Your Address: ${truncateAddress(myAddress)}
                </div>
                ${p1 ? `
                <div class="bg-blue-500 hover:bg-blue-600 text-white cursor-pointer px-3 py-1 rounded-full text-xs transition-colors duration-200">
                    Player 1 (X): ${truncateAddress(p1)}
                </div>` : ''}
                ${p2 ? `
                <div class="bg-red-500 hover:bg-red-600 text-white cursor-pointer px-3 py-1 rounded-full text-xs transition-colors duration-200">
                    Player 2 (O): ${truncateAddress(p2)}
                </div>` : ''}
            `;
        }

        /**
         * @dev Renders the game board grid.
         * @param gameState The current state of the game.
         */
        async function renderBoard(gameState) {
            boardGrid.innerHTML = ''; // Clear the board
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const state = (await contract.board(i, j)).toNumber();
                    const isClickable = gameState === 1 && userAddress.toLowerCase() === currentPlayerAddress.toLowerCase() && state === 0;

                    let iconSvg = '';
                    if (state === 1) { // Player 1
                        iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`;
                    } else if (state === 2) { // Player 2
                        iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><circle cx="12" cy="12" r="10"/></svg>`;
                    }

                    const cellClasses = `
                        flex items-center justify-center p-2 rounded-lg transition-all duration-200
                        ${isClickable ? 'cursor-pointer hover:bg-gray-100' : 'cursor-not-allowed'}
                        ${gameState === 1 && userAddress.toLowerCase() === currentPlayerAddress.toLowerCase() ? 'border-4 border-dashed border-blue-300' : 'border-2 border-gray-300'}
                        bg-white shadow-sm
                    `;
                    
                    const cell = document.createElement('div');
                    cell.className = cellClasses;
                    cell.setAttribute('data-row', i);
                    cell.setAttribute('data-col', j);
                    cell.innerHTML = iconSvg;
                    cell.addEventListener('click', () => {
                        if (isClickable) {
                            handleMakeMove(i, j);
                        }
                    });
                    boardGrid.appendChild(cell);
                }
            }
        }

        /**
         * @dev Renders the game action buttons based on the game state.
         * @param gameState The current state of the game.
         */
        function renderGameActions(gameState) {
            gameActionsDiv.innerHTML = ''; // Clear buttons

            if (gameState === 0 && userAddress.toLowerCase() !== player1Address.toLowerCase()) {
                // Show join game button
                const joinButton = document.createElement('button');
                joinButton.id = 'join-game-btn';
                joinButton.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-full py-2 px-6 transition-colors duration-200';
                joinButton.textContent = 'Join Game';
                joinButton.addEventListener('click', handleJoinGame);
                gameActionsDiv.appendChild(joinButton);
            }
            
            if ((gameState === 2 || gameState === 3 || gameState === 4) && 
                (userAddress.toLowerCase() === player1Address.toLowerCase() || userAddress.toLowerCase() === player2Address.toLowerCase())) {
                // Show reset game button
                const resetButton = document.createElement('button');
                resetButton.id = 'reset-game-btn';
                resetButton.className = 'bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-full py-2 px-6 transition-colors duration-200 flex items-center';
                resetButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 icon"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>Reset Game`;
                resetButton.addEventListener('click', handleResetGame);
                gameActionsDiv.appendChild(resetButton);
            }
        }
        
        // --- Game Logic Functions ---

        async function handleJoinGame() {
            if (!contract) return;
            try {
                const tx = await contract.joinGame();
                await tx.wait();
                showMessage("Joined Game", "You have successfully joined the game!");
                updateUI();
            } catch (error) {
                console.error("Error joining game:", error);
                showMessage("Transaction Failed", "Could not join the game. Check the console for details.");
            }
        }

        async function handleMakeMove(row, col) {
            if (!contract) return;
            if (userAddress.toLowerCase() !== currentPlayerAddress.toLowerCase()) {
                showMessage("Not Your Turn", "It is not your turn to make a move.");
                return;
            }
            try {
                const tx = await contract.makeMove(row, col);
                await tx.wait();
                showMessage("Move Made", "Your move has been submitted to the blockchain!");
                updateUI();
            } catch (error) {
                console.error("Error making move:", error);
                showMessage("Transaction Failed", "Could not make the move. Is the square already taken or is it not your turn?");
            }
        }

        async function handleResetGame() {
            if (!contract) return;
            try {
                const tx = await contract.resetGame();
                await tx.wait();
                showMessage("Game Reset", "The game has been reset and a new round has started!");
                updateUI();
            } catch (error) {
                console.error("Error resetting game:", error);
                showMessage("Transaction Failed", "Could not reset the game. Make sure the game is over and you are a player.");
            }
        }

        // --- Event Listeners ---

        function startEventListeners() {
            // Listen for events to update the UI in real-time
            contract.on("GameStarted", () => {
                console.log("GameStarted event received!");
                updateUI();
            });

            contract.on("MoveMade", () => {
                console.log("MoveMade event received!");
                updateUI();
            });

            contract.on("GameEnded", (winner) => {
                console.log("GameEnded event received!", winner);
                updateUI();
            });
        }

        // Add event listener to the "Connect Wallet" button
        connectWalletBtn.addEventListener('click', connectWallet);

        // Remove the automatic connection attempt on page load
        /*
        window.addEventListener('load', () => {
            if (typeof window.ethereum !== 'undefined' && window.ethereum.selectedAddress) {
                connectWallet();
            }
        });
        */

    </script>
</body>
</html>
