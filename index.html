<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Somnia Tic-Tac-Toe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            overflow: hidden;
        }
        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 10px;
            margin-top: 2rem;
        }
        .cell {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .cell:hover:not([disabled]) {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        .cell.player-1 { color: #f9d923; }
        .cell.player-2 { color: #50c4f8; }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.show {
            display: block;
            opacity: 1;
        }
        .disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body class="p-8">
    <div id="app" class="flex flex-col items-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full flex flex-col items-center text-gray-800">
            <h1 class="text-3xl font-bold mb-4">Tic Tac Toe on Somnia</h1>

            <div id="account-info" class="text-sm text-gray-500 mb-4 text-center hidden">
                <p>Connected as: <span id="account-address" class="font-mono text-gray-700"></span></p>
                <p id="player1-info" class="mt-1"></p>
                <p id="player2-info" class="mt-1"></p>
            </div>
            
            <div id="game-container" class="hidden">
                <div id="gameBoard" class="grid grid-cols-3 gap-2 p-2 bg-gray-200 rounded-lg shadow-inner">
                    <button class="cell" data-index="0"></button>
                    <button class="cell" data-index="1"></button>
                    <button class="cell" data-index="2"></button>
                    <button class="cell" data-index="3"></button>
                    <button class="cell" data-index="4"></button>
                    <button class="cell" data-index="5"></button>
                    <button class="cell" data-index="6"></button>
                    <button class="cell" data-index="7"></button>
                    <button class="cell" data-index="8"></button>
                </div>
            </div>

            <p id="status-message" class="mt-6 text-lg font-bold text-gray-800">Please connect your wallet to play.</p>
            
            <div id="message-container" class="mt-4 p-3 bg-indigo-100 text-indigo-800 rounded-lg text-center font-medium hidden"></div>

            <button id="connect-wallet-btn" class="mt-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                Connect Wallet
            </button>
            <button id="join-game-btn" class="mt-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors hidden">
                Join Game
            </button>
        </div>
    </div>
    <div id="messageBox" class="message-box opacity-0"></div>

    <script>
        // --- CONFIGURATION ---
        const CONTRACT_ADDRESS = "0xC2EF20399F24F74E23CeE8acCD2D56C9528BECb7";
        const SOMNIA_CHAIN_ID = 50312; // Chain ID for Somnia Testnet

        const contractABI = [
            {
                "inputs": [],
                "name": "joinGame",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint8",
                        "name": "position",
                        "type": "uint8"
                    }
                ],
                "name": "makeMove",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "p1",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "p2",
                        "type": "address"
                    }
                ],
                "name": "GameStarted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint8",
                        "name": "finalState",
                        "type": "uint8"
                    }
                ],
                "name": "GameOver",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint8",
                        "name": "position",
                        "type": "uint8"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint8",
                        "name": "value",
                        "type": "uint8"
                    }
                ],
                "name": "MoveMade",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "board",
                "outputs": [
                    {
                        "internalType": "uint8",
                        "name": "",
                        "type": "uint8"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "checkWinner",
                "outputs": [
                    {
                        "internalType": "uint8",
                        "name": "",
                        "type": "uint8"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "currentPlayer",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "gameActive",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getBoard",
                "outputs": [
                    {
                        "internalType": "uint8[9]",
                        "name": "",
                        "type": "uint8[9]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "player1",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "player2",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // --- DOM ELEMENTS ---
        const connectWalletBtn = document.getElementById("connect-wallet-btn");
        const joinGameBtn = document.getElementById("join-game-btn");
        const gameBoard = document.getElementById("gameBoard");
        const statusMessage = document.getElementById("status-message");
        const accountAddressEl = document.getElementById("account-address");
        const player1InfoEl = document.getElementById("player1-info");
        const player2InfoEl = document.getElementById("player2-info");
        const accountInfoEl = document.getElementById("account-info");
        const gameContainerEl = document.getElementById("game-container");
        const messageContainerEl = document.getElementById("message-container");

        // --- GAME STATE VARIABLES ---
        let provider, signer, contract;
        let userAccount;
        let isGameActive;
        let winner;
        let currentPlayerAddress;

        // --- HELPER FUNCTIONS ---
        function showMessage(message, isError = false) {
            messageContainerEl.textContent = message;
            messageContainerEl.classList.remove('hidden');
            if (isError) {
                messageContainerEl.classList.remove('bg-indigo-100', 'text-indigo-800');
                messageContainerEl.classList.add('bg-red-100', 'text-red-800');
            } else {
                messageContainerEl.classList.add('bg-indigo-100', 'text-indigo-800');
                messageContainerEl.classList.remove('bg-red-100', 'text-red-800');
            }
        }

        async function fetchGameState() {
            if (!contract) {
                console.warn("Contract not initialized. Skipping state fetch.");
                return;
            }

            try {
                const board = await contract.getBoard();
                const [active, winnerValue, current, p1, p2] = await Promise.all([
                    contract.gameActive(),
                    contract.checkWinner(),
                    contract.currentPlayer(),
                    contract.player1(),
                    contract.player2()
                ]);

                isGameActive = active;
                winner = Number(winnerValue);
                currentPlayerAddress = current;

                renderBoard(board.map(Number));
                updateStatus(isGameActive, winner, current, p1, p2, board.map(Number));
                updatePlayerInfo(p1, p2);

            } catch (err) {
                console.error("Error fetching game state:", err);
                showMessage("Failed to fetch game state. Check console.", true);
            }
        }

        function renderBoard(board) {
            const cells = gameBoard.querySelectorAll('.cell');
            cells.forEach((cell, i) => {
                cell.textContent = "";
                cell.classList.remove('player-1', 'player-2');
                cell.disabled = true;

                if (board[i] === 1) {
                    cell.textContent = "❌";
                    cell.classList.add('player-1');
                } else if (board[i] === 2) {
                    cell.textContent = "⭕";
                    cell.classList.add('player-2');
                }
                
                if (isGameActive && winner === 0 && currentPlayerAddress.toLowerCase() === userAccount.toLowerCase() && board[i] === 0) {
                    cell.disabled = false;
                }
            });
        }

        function updateStatus(active, winnerValue, current, p1, p2, board) {
            let statusText = "Please connect your wallet.";
            joinGameBtn.classList.add('hidden');

            if (winnerValue === 1) {
                statusText = "❌ Player 1 wins!";
            } else if (winnerValue === 2) {
                statusText = "⭕ Player 2 wins!";
            } else if (!active && board.every(c => c !== 0)) {
                statusText = "🤝 It's a draw!";
            } else if (!active) {
                statusText = "Waiting for another player to join...";
                if (userAccount && p1 && p1.toLowerCase() !== userAccount.toLowerCase()) {
                    joinGameBtn.classList.remove('hidden');
                }
            } else if (active) {
                if (current.toLowerCase() === userAccount.toLowerCase()) {
                    statusText = "🎯 Your Turn";
                } else {
                    statusText = "⏳ Waiting for Opponent";
                }
            }
            statusMessage.textContent = statusText;
        }

        function updatePlayerInfo(p1, p2) {
            accountInfoEl.classList.remove('hidden');
            if (p1) {
                player1InfoEl.textContent = `Player 1 (X): ${p1.substring(0, 6)}...`;
            }
            if (p2 && p2 !== ethers.constants.AddressZero) {
                player2InfoEl.textContent = `Player 2 (O): ${p2.substring(0, 6)}...`;
            } else {
                player2InfoEl.textContent = `Player 2: Waiting...`;
            }
        }

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showMessage("MetaMask is not installed. Please install it to play.", true);
                return;
            }

            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                const network = await provider.getNetwork();

                if (network.chainId !== SOMNIA_CHAIN_ID) {
                    throw new Error(`Please switch to the Somnia Testnet (Chain ID: ${SOMNIA_CHAIN_ID}).`);
                }

                signer = provider.getSigner();
                userAccount = await signer.getAddress();
                accountAddressEl.textContent = `${userAccount.substring(0, 6)}...${userAccount.substring(userAccount.length - 4)}`;
                
                contract = new ethers.Contract(CONTRACT_ADDRESS, contractABI, signer);
                
                connectWalletBtn.classList.add('hidden');
                gameContainerEl.classList.remove('hidden');
                
                contract.on("GameStarted", (p1, p2) => {
                    showMessage("Game started!");
                    fetchGameState();
                });
                contract.on("MoveMade", (player, position, value) => {
                    showMessage(`Player ${value === 1 ? 'X' : 'O'} made a move!`);
                    fetchGameState();
                });
                contract.on("GameOver", (finalState) => {
                    let winMsg = "Game Over!";
                    if (finalState === 1) winMsg = "Player 1 Wins!";
                    if (finalState === 2) winMsg = "Player 2 Wins!";
                    if (finalState === 3) winMsg = "It's a draw!";
                    showMessage(winMsg);
                    fetchGameState();
                });

                fetchGameState();

            } catch (err) {
                console.error("Error in connectWallet:", err);
                const errorMessage = err.message || "An error occurred.";
                showMessage(errorMessage, true);
            }
        }

        async function handleMove(event) {
            if (!contract || !isGameActive) return;
            const position = event.target.dataset.index;
            
            try {
                const tx = await contract.makeMove(parseInt(position));
                showMessage("Transaction sent... waiting for confirmation.");
                await tx.wait();
            } catch (err) {
                console.error("Transaction failed:", err);
                const reason = err.data?.message || err.message;
                showMessage(reason.split('revert ')[1] || "An error occurred.", true);
            }
        }
        
        async function handleJoinGame() {
            if (!contract) return;
            try {
                const tx = await contract.joinGame();
                showMessage("Joining game... waiting for confirmation.");
                await tx.wait();
                joinGameBtn.classList.add('hidden');
            } catch (err) {
                console.error("Transaction failed:", err);
                const reason = err.data?.message || err.message;
                showMessage(reason.split('revert ')[1] || "An error occurred.", true);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            connectWalletBtn.addEventListener('click', connectWallet);
            gameBoard.addEventListener('click', handleMove);
            joinGameBtn.addEventListener('click', handleJoinGame);
        });
    </script>
</body>
</html>
