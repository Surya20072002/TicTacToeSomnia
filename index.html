<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Somnia Tic-Tac-Toe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            overflow: hidden;
        }
        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 10px;
            margin-top: 2rem;
        }
        .cell {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .cell:hover:not([disabled]) {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        .cell.player-1 { color: #f9d923; }
        .cell.player-2 { color: #50c4f8; }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.show {
            display: block;
            opacity: 1;
        }
        .disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body class="p-8">
    <div id="app" class="flex flex-col items-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full flex flex-col items-center text-gray-800">
            <h1 class="text-3xl font-bold mb-4">Tic Tac Toe on Somnia</h1>

            <div id="account-info" class="text-sm text-gray-500 mb-4 text-center hidden">
                <p>Connected as: <span id="account-address" class="font-mono text-gray-700"></span></p>
                <p id="player1-info" class="mt-1"></p>
                <p id="player2-info" class="mt-1"></p>
            </div>
            
            <div id="game-container" class="hidden">
                <div id="gameBoard" class="grid grid-cols-3 gap-2 p-2 bg-gray-200 rounded-lg shadow-inner">
                    <button class="cell" data-index="0"></button>
                    <button class="cell" data-index="1"></button>
                    <button class="cell" data-index="2"></button>
                    <button class="cell" data-index="3"></button>
                    <button class="cell" data-index="4"></button>
                    <button class="cell" data-index="5"></button>
                    <button class="cell" data-index="6"></button>
                    <button class="cell" data-index="7"></button>
                    <button class="cell" data-index="8"></button>
                </div>
            </div>

            <p id="status-message" class="mt-6 text-lg font-bold text-gray-800">Please connect your wallet to play.</p>
            
            <div id="message-container" class="mt-4 p-3 bg-indigo-100 text-indigo-800 rounded-lg text-center font-medium hidden"></div>

            <button id="connect-wallet-btn" class="mt-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                Connect Wallet
            </button>
            <button id="join-game-btn" class="mt-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors hidden">
                Join Game
            </button>
        </div>
    </div>
    <div id="messageBox" class="message-box opacity-0"></div>

    <script>
        // --- CONFIGURATION ---
        // NOTE: Remember to replace this with your deployed contract address.
        const CONTRACT_ADDRESS = "YOUR_CONTRACT_ADDRESS_HERE";
        
        // ABI derived from the final working Solidity contract.
        const contractABI = [
            "function board(uint256) view returns (uint8)",
            "function currentPlayer() view returns (address)",
            "function gameState() view returns (uint8)",
            "function player1() view returns (address)",
            "function player2() view returns (address)",
            "function joinGame() external",
            "function makeMove(uint8 position) external",
            "event GameStarted(address indexed p1, address indexed p2)",
            "event MoveMade(address indexed player, uint8 position, uint8 value)",
            "event GameOver(uint8 finalState)"
        ];

        // --- DOM ELEMENTS ---
        const connectWalletBtn = document.getElementById("connect-wallet-btn");
        const joinGameBtn = document.getElementById("join-game-btn");
        const gameBoard = document.getElementById("gameBoard");
        const statusMessage = document.getElementById("status-message");
        const accountAddressEl = document.getElementById("account-address");
        const player1InfoEl = document.getElementById("player1-info");
        const player2InfoEl = document.getElementById("player2-info");
        const accountInfoEl = document.getElementById("account-info");
        const gameContainerEl = document.getElementById("game-container");
        const messageContainerEl = document.getElementById("message-container");

        // --- GAME STATE VARIABLES ---
        let provider, signer, contract;
        let userAccount;
        let currentGameState;
        let currentPlayerAddress;

        // GameState enum mapping for readability
        const GameState = {
            WaitingForPlayer: 0,
            InProgress: 1,
            Player1Wins: 2,
            Player2Wins: 3,
            Draw: 4,
        };

        // --- HELPER FUNCTIONS ---
        // Displays a message to the user in the UI.
        function showMessage(message, isError = false) {
            messageContainerEl.textContent = message;
            messageContainerEl.classList.remove('hidden');
            if (isError) {
                messageContainerEl.classList.remove('bg-indigo-100', 'text-indigo-800');
                messageContainerEl.classList.add('bg-red-100', 'text-red-800');
            } else {
                messageContainerEl.classList.add('bg-indigo-100', 'text-indigo-800');
                messageContainerEl.classList.remove('bg-red-100', 'text-red-800');
            }
        }

        // Asynchronously fetches the latest game state from the blockchain.
        async function fetchGameState() {
            // Check if the contract object is initialized before making calls
            if (!contract) {
                console.warn("Contract not initialized. Skipping state fetch.");
                return;
            }

            try {
                // Fetch the board state
                const boardPromises = [...Array(9).keys()].map(i => contract.board(i));
                const board = await Promise.all(boardPromises);

                // Fetch other game state variables
                const [state, current, p1, p2] = await Promise.all([
                    contract.gameState(),
                    contract.currentPlayer(),
                    contract.player1(),
                    contract.player2()
                ]);

                currentGameState = Number(state);
                currentPlayerAddress = current;

                // Update UI based on fetched data
                renderBoard(board.map(Number));
                updateStatus(state, current, p1, p2);
                updatePlayerInfo(p1, p2);

            } catch (err) {
                console.error("Error fetching game state:", err);
                showMessage("Failed to fetch game state. Check console.", true);
            }
        }

        // Renders the board based on the game state.
        function renderBoard(board) {
            const cells = gameBoard.querySelectorAll('.cell');
            cells.forEach((cell, i) => {
                cell.textContent = "";
                cell.classList.remove('player-1', 'player-2');
                cell.disabled = true; // Disable all cells by default

                if (board[i] === 1) {
                    cell.textContent = "âŒ";
                    cell.classList.add('player-1');
                } else if (board[i] === 2) {
                    cell.textContent = "â­•";
                    cell.classList.add('player-2');
                }
                
                // Enable cells only if it's the current player's turn and the spot is empty
                if (currentGameState === GameState.InProgress && 
                    currentPlayerAddress.toLowerCase() === userAccount.toLowerCase() && 
                    board[i] === 0) {
                    cell.disabled = false;
                }
            });
        }

        // Updates the status message for the user.
        function updateStatus(state, current, p1, p2) {
            let statusText = "Please connect your wallet.";
            joinGameBtn.classList.add('hidden');

            if (state == GameState.WaitingForPlayer) {
                statusText = "Waiting for another player to join...";
                if (userAccount && p1 && p1.toLowerCase() !== userAccount.toLowerCase()) {
                    joinGameBtn.classList.remove('hidden');
                }
            } else if (state == GameState.InProgress) {
                if (current.toLowerCase() === userAccount.toLowerCase()) {
                    statusText = "ðŸŽ¯ Your Turn";
                } else {
                    statusText = "â³ Waiting for Opponent";
                }
            } else if (state == GameState.Player1Wins) {
                statusText = "âŒ Player 1 wins!";
            } else if (state == GameState.Player2Wins) {
                statusText = "â­• Player 2 wins!";
            } else if (state == GameState.Draw) {
                statusText = "ðŸ¤ It's a draw!";
            }
            statusMessage.textContent = statusText;
        }

        // Updates the player addresses displayed on the UI.
        function updatePlayerInfo(p1, p2) {
            accountInfoEl.classList.remove('hidden');
            if (p1) {
                player1InfoEl.textContent = `Player 1 (X): ${p1.substring(0, 6)}...`;
            }
            if (p2 && p2 !== ethers.constants.AddressZero) {
                player2InfoEl.textContent = `Player 2 (O): ${p2.substring(0, 6)}...`;
            } else {
                player2InfoEl.textContent = `Player 2: Waiting...`;
            }
        }

        // --- EVENT HANDLERS ---
        // Connects to MetaMask and sets up the contract instance.
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showMessage("MetaMask is not installed. Please install it to play.", true);
                return;
            }

            try {
                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                accountAddressEl.textContent = `${userAccount.substring(0, 6)}...${userAccount.substring(userAccount.length - 4)}`;

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                
                contract = new ethers.Contract(CONTRACT_ADDRESS, contractABI, signer);
                
                // Hide connect button, show game UI
                connectWalletBtn.classList.add('hidden');
                gameContainerEl.classList.remove('hidden');
                
                // Set up event listeners for real-time updates
                contract.on("GameStarted", (p1, p2) => {
                    showMessage("Game started!");
                    fetchGameState();
                });
                contract.on("MoveMade", (player, position, value) => {
                    showMessage(`Player ${value === 1 ? 'X' : 'O'} made a move!`);
                    fetchGameState();
                });
                contract.on("GameOver", (finalState) => {
                    let winMsg = "Game Over!";
                    if (finalState === GameState.Player1Wins) winMsg = "Player 1 Wins!";
                    if (finalState === GameState.Player2Wins) winMsg = "Player 2 Wins!";
                    if (finalState === GameState.Draw) winMsg = "It's a draw!";
                    showMessage(winMsg);
                    fetchGameState();
                });

                // Fetch initial game state
                fetchGameState();

            } catch (err) {
                console.error("Error in connectWallet:", err);
                showMessage("Failed to connect. Check console and make sure MetaMask is on the Somnia Testnet.", true);
            }
        }

        // Handles a cell click to make a move on the contract.
        async function handleMove(event) {
            if (!contract || currentGameState !== GameState.InProgress) return;
            const position = event.target.dataset.index;
            
            try {
                const tx = await contract.makeMove(parseInt(position));
                showMessage("Transaction sent... waiting for confirmation.");
                await tx.wait();
            } catch (err) {
                console.error("Transaction failed:", err);
                const reason = err.data?.message || err.message;
                showMessage(reason.split('revert ')[1] || "An error occurred.", true);
            }
        }
        
        // Handles a player joining the game.
        async function handleJoinGame() {
            if (!contract) return;
            try {
                const tx = await contract.joinGame();
                showMessage("Joining game... waiting for confirmation.");
                await tx.wait();
                joinGameBtn.classList.add('hidden');
            } catch (err) {
                console.error("Transaction failed:", err);
                const reason = err.data?.message || err.message;
                showMessage(reason.split('revert ')[1] || "An error occurred.", true);
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            connectWalletBtn.addEventListener('click', connectWallet);
            gameBoard.addEventListener('click', handleMove);
            joinGameBtn.addEventListener('click', handleJoinGame);
        });
    </script>
</body>
</html>
