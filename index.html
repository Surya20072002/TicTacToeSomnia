import { useEffect, useState } from "react";
import { ethers } from "ethers";

const contractABI = [
  {
    "inputs": [],
    "name": "joinGame",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function",
  },
  {
    "inputs": [{ "internalType": "uint8", "name": "position", "type": "uint8" }],
    "name": "makeMove",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function",
  },
  {
    "inputs": [],
    "name": "getBoard",
    "outputs": [{ "internalType": "uint8[9]", "name": "", "type": "uint8[9]" }],
    "stateMutability": "view",
    "type": "function",
  },
  {
    "inputs": [],
    "name": "checkWinner",
    "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }],
    "stateMutability": "view",
    "type": "function",
  },
  {
    "inputs": [],
    "name": "currentPlayer",
    "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
    "stateMutability": "view",
    "type": "function",
  },
  {
    "inputs": [],
    "name": "player1",
    "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
    "stateMutability": "view",
    "type": "function",
  },
  {
    "inputs": [],
    "name": "player2",
    "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
    "stateMutability": "view",
    "type": "function",
  },
];

const contractAddress = import.meta.env.VITE_CONTRACT_ADDRESS;

export default function Index() {
  const [board, setBoard] = useState<number[]>(Array(9).fill(0));
  const [contract, setContract] = useState<any>(null);
  const [account, setAccount] = useState<string>("");
  const [winner, setWinner] = useState<number>(0);
  const [currentPlayer, setCurrentPlayer] = useState<string>("");

  useEffect(() => {
    const load = async () => {
      if (window.ethereum) {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const accounts = await provider.send("eth_requestAccounts", []);
        const signer = provider.getSigner();
        setAccount(accounts[0]);

        const instance = new ethers.Contract(
          contractAddress,
          contractABI,
          signer
        );
        setContract(instance);

        const bd = await instance.getBoard();
        setBoard(bd.map(Number));

        const player = await instance.currentPlayer();
        setCurrentPlayer(player);

        const winner = await instance.checkWinner();
        setWinner(Number(winner));
      }
    };
    load();
  }, []);

  const handleMove = async (i: number) => {
    if (!contract) return;
    const updatedBoard = await contract.getBoard();
    if (updatedBoard[i] !== 0 || winner !== 0) return;

    try {
      const tx = await contract.makeMove(i);
      await tx.wait();
      const newBoard = await contract.getBoard();
      setBoard(newBoard.map(Number));

      const player = await contract.currentPlayer();
      setCurrentPlayer(player);

      const winner = await contract.checkWinner();
      setWinner(Number(winner));
    } catch (err) {
      console.error("Transaction failed:", err);
    }
  };

  const getStatus = () => {
    if (winner === 1) return "❌ Player 1 wins!";
    if (winner === 2) return "⭕ Player 2 wins!";
    if (board.every((c) => c !== 0)) return "🤝 It's a draw!";
    return currentPlayer === account ? "🎯 Your Turn" : "⏳ Waiting for Opponent";
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-8 bg-gray-100">
      <h1 className="text-3xl font-bold mb-4">Tic Tac Toe 🧠 on Somnia</h1>
      <div className="grid grid-cols-3 gap-2">
        {board.map((cell, i) => (
          <button
            key={i}
            className="w-20 h-20 text-2xl font-bold bg-white border rounded shadow"
            onClick={() => handleMove(i)}
          >
            {cell === 1 ? "❌" : cell === 2 ? "⭕" : ""}
          </button>
        ))}
      </div>
      <p className="mt-4 text-lg font-medium">{getStatus()}</p>
      <p className="mt-2 text-sm text-gray-500">Connected as: {account}</p>
    </div>
  );
}
